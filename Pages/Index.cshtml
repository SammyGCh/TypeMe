@page "/login"
@model IndexModel
@{
    ViewData["Title"] = "Login";
}

<link rel="stylesheet" href="~/css/login.css"/>

<div class="d-flex justify-content-center">
    <div class="tarjeta-login col-xl-4 col-lg-4 col-md-6">
        <div class="tarjeta-login__logo">
            <img src="~/img/Logo.png" alt="Logo TypeMe">
        </div>

        <form class="formulario" method="POST">
            <label for="usuario" class="formulario__label">Usuario</label><br>
            <input name="usuario" id="Campo-usuario" type="text" class="formulario__input" oninput="manejarEntrada()"><br>

            <label for="password" class="formulario__label">Contraseña</label><br>
            <input name="password" id="Campo-contrasenia" type="password" class="formulario__input" oninput="manejarEntrada()"><br>

            <span id="mensajeError" style="color: red; display:none"></span>
            <div class="loader" id="loader"></div>
            <button class="boton-login" id="login">Iniciar sesión</button>
        </form>    
        <button class="boton-registrar" id="registrar">Crear cuenta</button>
    <div>
</div>


<script>

    const botonLogin = document.getElementById("login");
    const botonRegistrar= document.getElementById("registrar");  
    const inputUsuario = document.getElementById("Campo-usuario");
    const inputContrasenia = document.getElementById("Campo-contrasenia");

    
    botonLogin.addEventListener('click', e => {
        e.preventDefault();

        if(camposCompletos()){
            iniciarSesion();
        }else{
            mostrarCamposErroneos();
        }
    });

    botonRegistrar.addEventListener('click', () => {
        registrarCuenta();
    });

    inputUsuario.addEventListener("focus", () => {
        inputUsuario.classList.remove("formulario__input-error");
    });

    inputContrasenia.addEventListener("focus", () => {
        inputContrasenia.classList.remove("formulario__input-error");
    });


    function iniciarSesion()
    {
        $("#loader").show();
        $("#mensajeError").hide()
        
        botonLogin.disabled = true;
        botonRegistrar.disabled = true;
        var infoTyper = {
            identificadorTyper: inputUsuario.value,
            informacionComplementaria: inputContrasenia.value
        }

        let url = "http://localhost:4000/typers/loginTyper";
        
        $.ajax({
            type: "POST",
            url: "http://localhost:4000/typers/loginTyper",
            dataType: "json",
            async: true,
            contentType: "application/json",
            data: JSON.stringify(infoTyper),
            success: function(response) {
                
                if (response.status === true) {
                    
                    agregarSesion(response.result);
                    
                }
                else {
                    $("#loader").hide();
                    var mensajeError = $("#mensajeError")
                    mensajeError.text("Usuario y/o contraseña incorrectos. Por verifique la información.")
                    mensajeError.show()
                    botonLogin.disabled = false;
                    botonRegistrar.disabled = false;
                }
            },
            error: function(response) {
                var mensajeError = $("#mensajeError")
                mensajeError.text("Ocurrió un error con el servidor. Intente más tarde.")
                mensajeError.show()
                $("#loader").hide();
                botonLogin.disabled = false;
                botonRegistrar.disabled = false;
            }
        })
        
    }

    function agregarSesion(typer) {
        $.ajax({
            type: "POST",
            url: "/Login/AgregarSesion",
            contentType: "application/json",
            data: JSON.stringify(typer),
            success: function(result) {
                if (result.status === true)
                {
                    $("#loader").hide();
                    window.location.pathname = '/Principal'
                }
                else {
                    var mensajeError = $("#mensajeError")
                    mensajeError.text("Ocurrió un error con el servidor. Intente más tarde.")
                    mensajeError.show()
                    $("#loader").hide();
                    botonLogin.disabled = false;
                    botonRegistrar.disabled = false;
                }
            },
            error: function() {
                var mensajeError = $("#mensajeError")
                mensajeError.text("Ocurrió un error con el servidor. Intente más tarde.")
                mensajeError.show()
                $("#loader").hide();
                botonLogin.disabled = false;
                botonRegistrar.disabled = false;
            }
        })
    }


    function camposCompletos()
    {
        if(inputUsuario.value.trim() != "" && inputContrasenia.value.trim() != ""){
            return true;
        }else{
            return false;
        }    
    }

    function mostrarCamposErroneos()
    {
        if(inputUsuario.value.trim() == "" ){
            inputUsuario.classList.add("formulario__input-error");
        }
        
        if(inputContrasenia.value.trim() == "" ){
            inputContrasenia.classList.add("formulario__input-error");
        }
    }

    function registrarCuenta()
    {
        window.location.pathname = '/RegistrarCuenta'
    }

    function manejarEntrada() {
        $("#mensajeError").hide()
    }

</script>
